# 🎓 자동 학급 편성 프로그램

학생들을 다음 학년으로 균등하고 공정하게 배정하는 자동화 시스템

## 📋 목차
- [프로그램 개요](#프로그램-개요)
- [주요 기능](#주요-기능)
- [사용 방법](#사용-방법)
- [배포 방법](#배포-방법)
- [입력 파일 형식](#입력-파일-형식)
- [출력 파일 형식](#출력-파일-형식)
- [배정 알고리즘](#배정-알고리즘)
- [검증 항목](#검증-항목)

---

## 프로그램 개요

이 프로그램은 학생 명단과 분반/합반 규칙을 기반으로 다음 학년 학급을 자동으로 편성합니다.

### 핵심 원칙
- ✅ **공정성**: 성적, 성비, 학생 수를 균등하게 배분
- ✅ **규칙 준수**: 분반/합반 규칙 100% 준수
- ✅ **특수 고려**: 특수반 학생, 동명이인, 난이도 학생 특별 배치
- ✅ **투명성**: 전 과정 로그 출력 및 검증 가능

---

## 주요 기능

### 1. 규칙 기반 배정
- **분반 규칙**: 특정 학생들을 서로 다른 반에 배치
- **합반 규칙**: 특정 학생들을 같은 반에 배치
- **규칙 충돌 검증**: 논리적 모순 자동 탐지

### 2. 균형 배정
- **유효 인원**: 특수반 학생 가중치(×3), 전출생(×0) 고려하여 균등 배분
  - 특수반 학생 1명 = 일반 학생 3명 (교사 부담 고려)
  - 전출 예정 학생 = 0명 (실제 교육 대상 아님)
- **성비**: 남녀 학생 비율 균형 (유효 인원 기준)
- **성적**: 반별 평균 점수 균등 배분
- **난이도**: 지도 난이도가 높은 학생 균등 배분

### 3. 특수 배려
- **특수반 학생**: 한 반에 몰리지 않도록 분산 배치
- **동명이인**: 같은 반에 배치되지 않도록 자동 분리
- **전출 예정 학생**: 별도 집계

### 4. 검증 시스템
- 모든 규칙 준수 여부 자동 검증
- 반별 통계 요약 제공
- 배정 과정 단계별 로그 출력

### 5. 유연한 학급 수 설정 (NEW)
- **입력 자동 감지**: 5학년(원학년) 학급 수를 엑셀 시트에서 자동으로 감지
- **출력 사용자 설정**: 6학년(진급) 학급 수를 사용자가 자유롭게 설정 가능 (예: 6개 반, 8개 반 등)

---


## 사용 방법

### 방법 1: GUI 실행 파일 사용 (일반 사용자 권장)

#### macOS
1. `dist/학급편성.app` 더블클릭
2. 창이 열리면 **파일 선택** 버튼으로 파일 지정
   - 📚 학생 명단 파일 선택
   - 📋 분반/합반 규칙 파일 선택
3. **진급할 학급 수** 입력 (기본값: 7)
4. **🚀 학급 편성 시작** 버튼 클릭
5. 진행 상황 확인 후 완료 메시지 확인
6. 결과 파일은 명단 파일과 같은 폴더에 자동 저장

#### Windows
1. `dist/학급편성.exe` 더블클릭
2. 동일한 방식으로 사용

### 방법 2: Python 스크립트 실행 (개발자용)

#### GUI 버전 (PyQt6)
```bash
# 의존성 설치
pip3 install PyQt6 pandas openpyxl numpy

# 실행
python3 class_assigner_gui_qt.py
```

#### 콘솔 버전
```bash
# 의존성 설치
pip3 install pandas openpyxl numpy

# 실행 (같은 폴더에 입력 파일 필요)
python3 class_assigner.py
```

### 필요한 파일
```
01 가상 명단.xlsx    # 학생 명단 (학년 포함)
02 분반 합반할 학생 규칙.xlsx  # 분반/합반 규칙
```

### 결과 파일
```
03 배정 결과.xlsx     # 배정 결과 + 요약 (예: 6학년 배정 결과.xlsx)
```

---

## 배포 방법

### 실행 파일 빌드하기

프로그램을 실행 파일로 빌드하면 Python 설치 없이 사용 가능합니다.

#### macOS에서 .app 빌드

```bash
# 1. 의존성 설치
pip3 install -r requirements.txt
pip3 install pyinstaller

# 2. 빌드 스크립트 실행
chmod +x build.sh
./build.sh

# 3. 결과
# dist/학급편성.app 생성 (macOS 전용)
```

#### Windows에서 .exe 빌드

```cmd
REM 1. 의존성 설치
pip install -r requirements.txt
pip install pyinstaller

REM 2. 빌드 실행
pyinstaller --onefile --windowed --name="학급편성" class_assigner_gui_qt.py

REM 3. 결과
REM dist\학급편성.exe 생성 (Windows 전용)
```

### 배포 시 주의사항

1. **플랫폼 독립성**
   - macOS .app → macOS에서만 실행
   - Windows .exe → Windows에서만 실행
   - 각 OS에서 별도로 빌드 필요

2. **파일 구성**
   ```
   배포 폴더/
   ├── 학급편성.app (또는 .exe)
   ├── 01 가상 명단.xlsx (샘플)
   ├── 02 분반 합반할 학생 규칙.xlsx (샘플)
   └── README.md (사용 설명서)
   ```

3. **사용자 안내**
   - 실행 파일을 더블클릭하면 자동으로 같은 폴더의 파일을 찾음
   - 파일이 없으면 파일 선택 대화상자가 나타남
   - 결과는 입력 파일과 같은 폴더에 저장됨
   
---

## 입력 파일 형식

### 1. `01 가상 명단.xlsx`

**시트 구성**: `5-1`, `5-2`, `5-3`, `5-4`, `5-5`, `5-6`, `5-7` (7개 시트)

**열 구성**:
| 열 이름 | 설명 | 예시 |
|--------|------|------|
| 학년 | 학년 | 5 |
| 반 | 반 번호 | 1-7 |
| 번호 | 학생 번호 | 1-24 |
| 이름 | 학생 이름 | 김철수 |
| 성별 | 성별 | 남/여 |
| 점수 | 성적 점수 | 85 |
| 특수반 | 특수반 여부 | 1 (특수반) / 공백 (일반) |
| 전출 | 전출 예정 여부 | 1 (전출) / 공백 (잔류) |
| 난이도 | 지도 난이도 | 2.0 (높음) / 공백 (보통) |
| 비고 | 기타 메모 | 학습부진, 쌍생아 등 |

### 2. `02 분반 합반할 학생 규칙.xlsx`

**시트 구성**: `Sheet1` (1개 시트)

**분반 규칙** (왼쪽 5개 열):
| 분반해야하는 학생 | | ↔ | | |
|---|---|---|---|---|
| 반 | 이름 | | 반 | 이름 |
| 1 | 강준우 | | 2 | 강하서 |

→ "강준우와 강하서는 서로 다른 반에 배치"

**합반 규칙** (오른쪽 5개 열):
| 합반해야하는 학생 | | ＋ | | |
|---|---|---|---|---|
| 반 | 이름 | | 반 | 이름 |
| 2 | 오시후 | | 2 | 오예아 |

→ "오시후와 오예아는 같은 반에 배치"

---

## 출력 파일 형식

### `03 [학년] 배정 결과.xlsx`

**시트 구성**: 총 8개 시트
- `요약`: 반별 통계 요약
- `6-1` ~ `6-7`: 각 반 학생 명단

#### 요약 시트
| 반 | 학생수 | 유효인원 | 남학생수 | 여학생수 | 유효남학생 | 유효여학생 | 난이도합 | 특수반수 | 전출생수 |
|---|-------|---------|---------|---------|-----------|-----------|---------|---------|---------|
| 6-1 | 20 | 22.0 | 8 | 12 | 10.0 | 12.0 | 5.0 | 1 | 1 |
| 6-2 | 21 | 24.0 | 10 | 11 | 12.0 | 12.0 | 5.0 | 1 | 0 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**유효 인원 계산**:
- 일반 학생: 1명
- 특수반 학생: 3명
- 전출 예정 학생: 0명

#### 각 반 시트 (6-1 ~ 6-7)
| 학년 | 반 | 번호 | 이름 | 성별 | 점수 | 특수반 | 전출 | 난이도 | 비고 | 원학년 | 원반 | 원번호 |
|-----|---|-----|-----|-----|-----|-------|-----|-------|------|-------|-----|-------|
| 6 | 1 | 1 | 강준우 | 남 | 92 | | | | | 5 | 3 | 12 |
| 6 | 1 | 2 | 권서나 | 여 | 90 | 1 | | 2.0 | 느티모반 | 5 | 1 | 8 |

**특징**:
- 학급 내 학생은 **이름 가나다순** 정렬
- 번호는 가나다순으로 1번부터 순차 부여 (새 반 번호)
- 남녀 구분 없이 통합 정렬
- **원학년, 원반, 원번호**: 5학년 때의 정보 (학생 추적용)
- **가독성 향상**:
  - 모든 셀에 **테두리** 적용
  - 헤더 **강조** (볼드체, 회색 배경)
  - 분반 규칙 학생 셀에 **메모** 자동 추가 ("분반 대상: OOO (X반)")
  - 요약 시트에 **범례** 제공

---

## 배정 알고리즘

프로그램은 6단계 배정 알고리즘을 사용합니다:

### Phase 0: 데이터 로드
- 모든 학생 데이터를 통합
- 성별별 등수(rank) 계산 및 저장
  - 남학생: 점수순으로 1~75등
  - 여학생: 점수순으로 1~77등

### Phase 1: 규칙 적용 🔴 (최우선)
- **합반 규칙** 먼저 적용 (제약이 더 강함)
  - 같은 그룹의 학생들을 한 반에 배치
  - **유효 인원**이 가장 적은 반에 배정
  - 배정 후 **잠금** (이후 변경 불가)
- **분반 규칙** 적용
  - 분반 규칙이 있는 학생을 먼저 배정 (미배정 시)
  - **2-tier 정렬**: 유효 인원이 적은 반 우선, 같으면 해당 성별이 적은 반 우선
  - 분반 대상 학생들을 서로 다른 반에 배치
  - 배정 후 **잠금**

### Phase 2: 특수반 학생 균등 배치 🟡
- 특수반 학생을 7개 반에 최대한 균등하게 배치
- **유효 인원** 기준으로 배정 (특수반 학생 = 3명 가중치)
- 분반 규칙 준수하면서 배치
- 배정 후 **잠금**

### Phase 3: 동명이인 분리 🟡
- 같은 이름의 학생들을 서로 다른 반에 배치
- 분반 규칙 준수
- 배정 후 **잠금**

### Phase 4: 난이도 균등 배분 🟢
- 지도 난이도가 높은 학생들을 균등하게 배치
- 난이도 합이 가장 낮은 반부터 배정
- 분반 규칙 준수
- 배정 후 **잠금**

### Phase 5: 반별 순환 배정 (동적 정렬 + 성비 균형) 🟢
- 기존 반 학생들이 새 학급에 골고루 분산되도록 배치
- **기존 반 처리 순서 랜덤 생성**
- 각 기존 반별로 남녀 교차 처리:
  1. **남학생 배정 시작 시**: 유효 인원 기준으로 반 정렬
     - **2-tier 정렬**: 유효 인원이 적은 반 우선, 같으면 유효 남학생이 적은 반 우선
     - 특정 반 남학생들(점수순) → 정렬된 순서대로 순환 배정
  2. **여학생 배정 시작 시**: 다시 유효 인원 기준으로 반 정렬
     - **2-tier 정렬**: 유효 인원이 적은 반 우선, 같으면 유효 여학생이 적은 반 우선
     - 특정 반 여학생들(점수순) → 정렬된 순서대로 순환 배정
   3. 다음 반 학생들 → 다시 정렬 후 배정
   4. ... 모든 반 반복
- 효과: **유효 인원 균형** + **성비 균형** + 성적 균형 + 기존 반 균등 분산
- 분반 규칙 100% 준수

### Phase 6: 예비 (사용 안 함)
- Phase 5에서 모든 학생이 배정되므로 실행되지 않음

---

## 검증 항목

프로그램은 다음 항목들을 자동으로 검증합니다:

### ✅ 필수 규칙 (Hard Constraints)
- [x] 분반 규칙 100% 준수
- [x] 합반 규칙 100% 준수
- [x] 동명이인 같은 반 배치 없음
- [x] 전체 학생 수 일치 (152명)

### ✅ 균형 목표 (Soft Constraints)
- [x] **유효 인원** 균등 배분 (±3명 이내)
- [x] **성비** 균등 배분 (유효 성별 인원 기준)
- [x] 성적 평균 균등 배분
- [x] 특수반 학생 분산 배치
- [x] 난이도 합 균등 배분
- [x] 기존 반 학생 골고루 분산

### ✅ 출력 품질
- [x] 각 반 이름 가나다순 정렬
- [x] 번호 순차 부여 (1번부터)
- [x] 요약 시트 통계 정확성

---

## 실행 예시

```bash
$ python3 class_assigner.py

======================================================================
🎓 자동 학급 편성 프로그램 시작
======================================================================

📚 Step 0: 학생 데이터 로드 중...
   ✅ 총 152명의 학생 데이터 로드 완료
   - 남학생: 75명
   - 여학생: 77명
   - 특수반: 2명
   - 전출생: 3명

📋 Step 1: 분반/합반 규칙 로드 중...
   ✅ 분반 규칙: 18쌍
   ✅ 합반 규칙: 1그룹 (1명)
   🔍 규칙 충돌 검증 중...
   ✅ 규칙 충돌 없음 - 모든 규칙이 논리적으로 일관됨

🎯 Phase 1: 분반/합반 규칙 적용 중...
   ✅ 합반 그룹 1: ['오시후'] → 1반
   ✅ Phase 1 완료: 1명 배정됨

🎯 Phase 2: 특수반 학생 균등 배치 중...
   ✅ 반별 특수반 학생 수: {1: 1, 2: 1, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0}

🎯 Phase 3: 동명이인 분리 중...
   - 동명이인: {'박찬대': 2}
   ✅ 동명이인 분리 완료

🎯 Phase 4: 난이도 균등 배분 중...
   ✅ 반별 난이도 합: {1: 5.0, 2: 5.0, 3: 5.0, 4: 5.0, 5: 4.0, 6: 4.0, 7: 4.0}

🎯 Phase 5: 종합 균형 조정 중...
   - 총 유효 인원: 156.0명
   - 반별 목표: 22.3명
   ✅ 종합 균형 조정 완료

📊 결과 생성 중...
   ✅ 결과 파일 저장: 03 6학년 배정 결과.xlsx

======================================================================
📋 반별 요약
======================================================================
  반  학생수  남학생수  여학생수  난이도합  특수반수  전출생수
6-1   20     8    12     5     1     1
6-2   21    10    11     5     1     0
6-3   23    12    11     5     0     0
6-4   22    11    11     5     0     1
6-5   22    11    11     4     0     0
6-6   22    11    11     4     0     1
6-7   22    12    10     4     0     0

======================================================================
🎉 학급 편성 완료!
======================================================================
```

---

## 문제 해결

### 규칙 충돌 오류 발생 시

```
⚠️  규칙 충돌 발견!
❌ 충돌: 학생A와 학생B는 합반해야 하지만 동시에 분반해야 함
```

**해결 방법**: `02 분반 합반할 학생 규칙.xlsx` 파일에서 충돌하는 규칙을 수정하세요.

### 배정 불가 경고 발생 시

```
⚠️  경고: 학생X를 배정할 수 없습니다 (규칙 충돌)
```

**원인**: 분반 규칙이 너무 많아서 특정 학생을 배치할 반이 없는 경우

**해결 방법**: 분반 규칙을 일부 완화하거나 조정하세요.

---

## 기술 스택

### 핵심 엔진
- **언어**: Python 3.9+
- **데이터 처리**:
  - `pandas`: 데이터 처리 및 분석
  - `openpyxl`: Excel 파일 읽기/쓰기
  - `numpy`: 수치 계산
  - `dataclasses`: 데이터 구조

### GUI (사용자 인터페이스)
- **PyQt6**: 크로스플랫폼 GUI 프레임워크
  - macOS, Windows 네이티브 룩앤필 지원
  - 다크모드 자동 대응
  - QThread 기반 백그라운드 처리

### 배포
- **PyInstaller**: 실행 파일 생성
  - macOS: .app 번들
  - Windows: .exe 실행 파일

### 프로젝트 구조
```
Class_Assignment 2/
├── class_assigner.py              # 핵심 배정 엔진 (콘솔)
├── class_assigner_gui_qt.py       # PyQt6 GUI 버전 ⭐
├── build.sh                       # macOS 빌드 스크립트
├── requirements.txt               # Python 의존성
├── 01 가상 명단.xlsx             # 샘플 입력 파일
├── 02 분반 합반할 학생 규칙.xlsx    # 샘플 규칙 파일
├── dist/
│   └── 학급편성.app               # 빌드된 실행 파일
└── tests/                         # 단위 테스트
    ├── test_validate_rules.py
    ├── test_phase1_apply_rules.py
    ├── test_phase2_distribute_special_needs.py
    └── test_phase5_balance_remaining.py
```

---

## 🧪 테스트

프로그램의 핵심 로직에 대한 단위 테스트가 포함되어 있습니다.

### 테스트 실행

```bash
# 모든 테스트 실행
pytest tests/ -v

# 규칙 검증 테스트만 실행
pytest tests/test_validate_rules.py -v

# 특정 테스트 실행
pytest tests/test_validate_rules.py::test_conflict_two_persons -v
```

### 테스트 커버리지

| 테스트 파일 | 테스트 수 | 대상 함수 | 커버리지 | 결과 문서 |
|------------|---------|----------|---------|-----------|
| `test_validate_rules.py` | 14개 | `_validate_rules` | 100% | [TEST_RESULTS.md](tests/TEST_RESULTS.md) |
| `test_phase1_apply_rules.py` | 13개 | `phase1_apply_rules` | 100% | [TEST_RESULTS_PHASE1.md](tests/TEST_RESULTS_PHASE1.md) |
| `test_phase2_distribute_special_needs.py` | 13개 | `phase2_distribute_special_needs` | 100% | [TEST_RESULTS_PHASE2.md](tests/TEST_RESULTS_PHASE2.md) |
| `test_phase5_balance_remaining.py` | 14개 | `phase5_balance_remaining` | 100% | [TEST_RESULTS_PHASE5.md](tests/TEST_RESULTS_PHASE5.md) |
| **합계** | **54개** | **4개 함수** | **100%** | - |

---

## 버전 히스토리

### v2.2 (2025-12-10)
- ✨ **Phase 1 분반 규칙 로직 대폭 개선**
  - 미배정 분반 학생을 Phase 1에서 적극 처리 (Phase 5 위임 제거)
  - 2-tier 정렬 적용: 유효 인원 + 성별 유효 인원 고려
  - 코드 중복 제거 및 일관성 향상
- ✨ **Phase 5 동적 정렬 + 성비 균형**
  - 각 성별 배정 시작 시 유효 인원 기준으로 동적 정렬
  - 2-tier 정렬: 유효 인원 + 해당 성별 유효 인원
  - 성비 균형 자동 달성
- ✨ **유효 인원 개념 도입**
  - 특수반 학생 = 3명, 전출생 = 0명 가중치
  - 모든 Phase에서 일관되게 적용
- 📊 **출력 파일 개선**
  - 원학년, 원반, 원번호 컬럼 추가 (학생 추적 용이)
  - 요약 시트에 유효인원, 유효남학생, 유효여학생 컬럼 추가
- ✅ 테스트 94개 전체 통과 (커버리지 100% 유지)

### v2.4 (2025-12-10)
- ✨ **범용성 강화 (Grade Agnostic)**
  - 특정 학년(5학년, 6학년) 의존성 제거
  - 입력 데이터에서 현재 학년 자동 감지 후 +1 학년으로 진급 처리
  - GUI 문구 및 파일명 일반화 (`01 가상 명단.xlsx`, `03 배정 결과.xlsx`)

### v2.3 (2025-12-10)
- ✨ **엑셀 출력 시각화 대폭 개선**
  - **직관적인 디자인**: 표 테두리, 헤더 스타일 적용
  - **스마트 메모 기능**: 분반 규칙 학생에게 "분반 대상: OOO (X반)" 메모 자동 표시
  - **상세 범례 추가**: 색상 구분(합반/분반)에 대한 친절한 설명 추가

### v2.0 (2025-11-21)
- ✨ PyQt6 기반 GUI 추가 (macOS/Windows 지원)
- 🎨 다크모드 자동 대응
- 📦 실행 파일 빌드 지원 (.app, .exe)
- 🔧 백그라운드 스레드 처리로 UI 응답성 개선
- 📝 Excel 결과 파일에 색상 표시 추가 (분반/합반 학생)

### v1.0 (2025-11-20)
- 🎉 최초 릴리스
- ✅ 6단계 배정 알고리즘 구현
- ✅ 분반/합반 규칙 100% 준수
- ✅ 균등 배분 (학생 수, 성비, 성적, 난이도)
- ✅ 단위 테스트 54개 작성 (커버리지 100%)

---

## 라이선스

이 프로그램은 교육 목적으로 자유롭게 사용할 수 있습니다.

---

## 문의

프로그램 사용 중 문제가 발생하면 개발자에게 문의하세요.

**최종 업데이트**: 2025년 12월 10일
**현재 버전**: 2.2
