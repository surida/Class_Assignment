# 🎓 자동 학급 편성 프로그램

5학년 학생 152명을 6학년 7개 반으로 균등하고 공정하게 배정하는 자동화 시스템

## 📋 목차
- [프로그램 개요](#프로그램-개요)
- [주요 기능](#주요-기능)
- [사용 방법](#사용-방법)
- [입력 파일 형식](#입력-파일-형식)
- [출력 파일 형식](#출력-파일-형식)
- [배정 알고리즘](#배정-알고리즘)
- [검증 항목](#검증-항목)

---

## 프로그램 개요

이 프로그램은 5학년 학생 명단과 분반/합반 규칙을 기반으로 6학년 7개 학급을 자동으로 편성합니다.

### 핵심 원칙
- ✅ **공정성**: 성적, 성비, 학생 수를 균등하게 배분
- ✅ **규칙 준수**: 분반/합반 규칙 100% 준수
- ✅ **특수 고려**: 특수반 학생, 동명이인, 난이도 학생 특별 배치
- ✅ **투명성**: 전 과정 로그 출력 및 검증 가능

---

## 주요 기능

### 1. 규칙 기반 배정
- **분반 규칙**: 특정 학생들을 서로 다른 반에 배치
- **합반 규칙**: 특정 학생들을 같은 반에 배치
- **규칙 충돌 검증**: 논리적 모순 자동 탐지

### 2. 균형 배정
- **학생 수**: 특수반 학생 가중치(×3) 고려하여 유효 인원 균등 배분
- **성비**: 남녀 학생 비율 균형
- **성적**: 반별 평균 점수 균등 배분
- **난이도**: 지도 난이도가 높은 학생 균등 배분

### 3. 특수 배려
- **특수반 학생**: 한 반에 몰리지 않도록 분산 배치
- **동명이인**: 같은 반에 배치되지 않도록 자동 분리
- **전출 예정 학생**: 별도 집계

### 4. 검증 시스템
- 모든 규칙 준수 여부 자동 검증
- 반별 통계 요약 제공
- 배정 과정 단계별 로그 출력

---

## 사용 방법

### 1. 필요한 파일 준비
```
01 5학년_가상 명단.xlsx    # 5학년 7개 반 학생 명단
02 분반 합반할 학생 규칙.xlsx  # 분반/합반 규칙
```

### 2. 프로그램 실행
```bash
python3 class_assigner.py
```

### 3. 결과 확인
```
03 6학년 배정 결과.xlsx     # 6학년 7개 반 배정 결과 + 요약
```

---

## 입력 파일 형식

### 1. `01 5학년_가상 명단.xlsx`

**시트 구성**: `5-1`, `5-2`, `5-3`, `5-4`, `5-5`, `5-6`, `5-7` (7개 시트)

**열 구성**:
| 열 이름 | 설명 | 예시 |
|--------|------|------|
| 학년 | 학년 | 5 |
| 반 | 반 번호 | 1-7 |
| 번호 | 학생 번호 | 1-24 |
| 이름 | 학생 이름 | 김철수 |
| 성별 | 성별 | 남/여 |
| 점수 | 성적 점수 | 85 |
| 특수반 | 특수반 여부 | 1 (특수반) / 공백 (일반) |
| 전출 | 전출 예정 여부 | 1 (전출) / 공백 (잔류) |
| 난이도 | 지도 난이도 | 2.0 (높음) / 공백 (보통) |
| 비고 | 기타 메모 | 학습부진, 쌍생아 등 |

### 2. `02 분반 합반할 학생 규칙.xlsx`

**시트 구성**: `Sheet1` (1개 시트)

**분반 규칙** (왼쪽 5개 열):
| 분반해야하는 학생 | | ↔ | | |
|---|---|---|---|---|
| 반 | 이름 | | 반 | 이름 |
| 1 | 강준우 | | 2 | 강하서 |

→ "강준우와 강하서는 서로 다른 반에 배치"

**합반 규칙** (오른쪽 5개 열):
| 합반해야하는 학생 | | ＋ | | |
|---|---|---|---|---|
| 반 | 이름 | | 반 | 이름 |
| 2 | 오시후 | | 2 | 오예아 |

→ "오시후와 오예아는 같은 반에 배치"

---

## 출력 파일 형식

### `03 6학년 배정 결과.xlsx`

**시트 구성**: 총 8개 시트
- `요약`: 반별 통계 요약
- `6-1` ~ `6-7`: 각 반 학생 명단

#### 요약 시트
| 반 | 학생수 | 남학생수 | 여학생수 | 난이도합 | 특수반수 | 전출생수 |
|---|-------|---------|---------|---------|---------|---------|
| 6-1 | 20 | 8 | 12 | 5.0 | 1 | 1 |
| 6-2 | 21 | 10 | 11 | 5.0 | 1 | 0 |
| ... | ... | ... | ... | ... | ... | ... |

#### 각 반 시트 (6-1 ~ 6-7)
| 학년 | 반 | 번호 | 이름 | 성별 | 점수 | 특수반 | 전출 | 난이도 | 비고 |
|-----|---|-----|-----|-----|-----|-------|-----|-------|------|
| 6 | 1 | 1 | 강준우 | 남 | 92 | | | | |
| 6 | 1 | 2 | 권서나 | 여 | 90 | 1 | | 2.0 | 느티모반 |

**특징**:
- 학급 내 학생은 **이름 가나다순** 정렬
- 번호는 가나다순으로 1번부터 순차 부여
- 남녀 구분 없이 통합 정렬

---

## 배정 알고리즘

프로그램은 6단계 배정 알고리즘을 사용합니다:

### Phase 0: 데이터 로드
- 5학년 7개 반 학생 데이터를 통합
- 성별별 등수(rank) 계산 및 저장
  - 남학생: 점수순으로 1~75등
  - 여학생: 점수순으로 1~77등

### Phase 1: 규칙 적용 🔴 (최우선)
- **합반 규칙** 먼저 적용 (제약이 더 강함)
  - 같은 그룹의 학생들을 한 반에 배치
  - 배정 후 **잠금** (이후 변경 불가)
- **분반 규칙** 적용
  - 이미 배정된 학생과 충돌하지 않도록 배치
  - 배정 후 **잠금**

### Phase 2: 특수반 학생 균등 배치 🟡
- 특수반 학생을 7개 반에 최대한 균등하게 배치
- 분반 규칙 준수하면서 배치
- 배정 후 **잠금**

### Phase 3: 동명이인 분리 🟡
- 같은 이름의 학생들을 서로 다른 반에 배치
- 분반 규칙 준수
- 배정 후 **잠금**

### Phase 4: 난이도 균등 배분 🟢
- 지도 난이도가 높은 학생들을 균등하게 배치
- 난이도 합이 가장 낮은 반부터 배정
- 분반 규칙 준수
- 배정 후 **잠금**

### Phase 5: 종합 균형 조정 🟢
- 남은 학생들을 배치하여 전체 균형 맞춤
- **유효 인원** 기준 배정 (특수반 학생 = 3명)
- 성별로 분리하여 배정
  1. 남학생: 유효 인원 적고 남학생 비율 낮은 반 우선
  2. 여학생: 유효 인원 적고 여학생 비율 낮은 반 우선
- 분반 규칙 준수

### Phase 6: 랜덤 순환 배정 🟢
- 혹시 남은 학생이 있을 경우 처리
- 성별로 분리 후 성적순 정렬
- 랜덤 반 순서로 순환 배정
  - 예: [2, 1, 5, 7, 4, 3, 6] 순서로
  - 1등 → 2반, 2등 → 1반, 3등 → 5반...

---

## 검증 항목

프로그램은 다음 항목들을 자동으로 검증합니다:

### ✅ 필수 규칙 (Hard Constraints)
- [x] 분반 규칙 100% 준수
- [x] 합반 규칙 100% 준수
- [x] 동명이인 같은 반 배치 없음
- [x] 전체 학생 수 일치 (152명)

### ✅ 균형 목표 (Soft Constraints)
- [x] 학생 수 균등 배분 (±2명 이내)
- [x] 성비 균등 배분
- [x] 성적 평균 균등 배분
- [x] 특수반 학생 분산 배치
- [x] 난이도 합 균등 배분

### ✅ 출력 품질
- [x] 각 반 이름 가나다순 정렬
- [x] 번호 순차 부여 (1번부터)
- [x] 요약 시트 통계 정확성

---

## 실행 예시

```bash
$ python3 class_assigner.py

======================================================================
🎓 자동 학급 편성 프로그램 시작
======================================================================

📚 Step 0: 학생 데이터 로드 중...
   ✅ 총 152명의 학생 데이터 로드 완료
   - 남학생: 75명
   - 여학생: 77명
   - 특수반: 2명
   - 전출생: 3명

📋 Step 1: 분반/합반 규칙 로드 중...
   ✅ 분반 규칙: 18쌍
   ✅ 합반 규칙: 1그룹 (1명)
   🔍 규칙 충돌 검증 중...
   ✅ 규칙 충돌 없음 - 모든 규칙이 논리적으로 일관됨

🎯 Phase 1: 분반/합반 규칙 적용 중...
   ✅ 합반 그룹 1: ['오시후'] → 1반
   ✅ Phase 1 완료: 1명 배정됨

🎯 Phase 2: 특수반 학생 균등 배치 중...
   ✅ 반별 특수반 학생 수: {1: 1, 2: 1, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0}

🎯 Phase 3: 동명이인 분리 중...
   - 동명이인: {'박찬대': 2}
   ✅ 동명이인 분리 완료

🎯 Phase 4: 난이도 균등 배분 중...
   ✅ 반별 난이도 합: {1: 5.0, 2: 5.0, 3: 5.0, 4: 5.0, 5: 4.0, 6: 4.0, 7: 4.0}

🎯 Phase 5: 종합 균형 조정 중...
   - 총 유효 인원: 156.0명
   - 반별 목표: 22.3명
   ✅ 종합 균형 조정 완료

📊 결과 생성 중...
   ✅ 결과 파일 저장: 03 6학년 배정 결과.xlsx

======================================================================
📋 반별 요약
======================================================================
  반  학생수  남학생수  여학생수  난이도합  특수반수  전출생수
6-1   20     8    12     5     1     1
6-2   21    10    11     5     1     0
6-3   23    12    11     5     0     0
6-4   22    11    11     5     0     1
6-5   22    11    11     4     0     0
6-6   22    11    11     4     0     1
6-7   22    12    10     4     0     0

======================================================================
🎉 학급 편성 완료!
======================================================================
```

---

## 문제 해결

### 규칙 충돌 오류 발생 시

```
⚠️  규칙 충돌 발견!
❌ 충돌: 학생A와 학생B는 합반해야 하지만 동시에 분반해야 함
```

**해결 방법**: `02 분반 합반할 학생 규칙.xlsx` 파일에서 충돌하는 규칙을 수정하세요.

### 배정 불가 경고 발생 시

```
⚠️  경고: 학생X를 배정할 수 없습니다 (규칙 충돌)
```

**원인**: 분반 규칙이 너무 많아서 특정 학생을 배치할 반이 없는 경우

**해결 방법**: 분반 규칙을 일부 완화하거나 조정하세요.

---

## 기술 스택

- **언어**: Python 3.x
- **라이브러리**:
  - `pandas`: 데이터 처리
  - `openpyxl`: Excel 파일 읽기/쓰기
  - `numpy`: 수치 계산
  - `dataclasses`: 데이터 구조

---

## 🧪 테스트

프로그램의 핵심 로직에 대한 단위 테스트가 포함되어 있습니다.

### 테스트 실행

```bash
# 모든 테스트 실행
pytest tests/ -v

# 규칙 검증 테스트만 실행
pytest tests/test_validate_rules.py -v

# 특정 테스트 실행
pytest tests/test_validate_rules.py::test_conflict_two_persons -v
```

### 테스트 커버리지

| 테스트 파일 | 테스트 수 | 대상 함수 | 커버리지 | 결과 문서 |
|------------|---------|----------|---------|-----------|
| `test_validate_rules.py` | 14개 | `_validate_rules` | 100% | [TEST_RESULTS.md](tests/TEST_RESULTS.md) |
| `test_phase1_apply_rules.py` | 13개 | `phase1_apply_rules` | 100% | [TEST_RESULTS_PHASE1.md](tests/TEST_RESULTS_PHASE1.md) |
| `test_phase2_distribute_special_needs.py` | 13개 | `phase2_distribute_special_needs` | 100% | [TEST_RESULTS_PHASE2.md](tests/TEST_RESULTS_PHASE2.md) |
| **합계** | **40개** | **3개 함수** | **100%** | - |

---

## 라이선스

이 프로그램은 교육 목적으로 자유롭게 사용할 수 있습니다.

---

## 문의

프로그램 사용 중 문제가 발생하면 개발자에게 문의하세요.

**개발일**: 2025년 11월
**버전**: 1.0
